"use strict";var faceDeformer=function(){var e,r,t,a,o,i,n,u,h,s,c,A,_,f,T,l=!0,R=!1;this.init=function(r){e=getWebGLContext(r)},this.load=function(R,g,p,v){_=p,r=v?v:_.path.vertices,t=r.length,a=0,o=R.width,i=0,n=R.height;for(var E=0;E<g.length;E++)g[E][0]>a&&(a=g[E][0]),g[E][0]<o&&(o=g[E][0]),g[E][1]>i&&(i=g[E][1]),g[E][1]<n&&(n=g[E][1]);if(o=Math.floor(o),a=Math.ceil(a),n=Math.floor(n),i=Math.ceil(i),u=a-o,h=i-n,"VIDEO"==R.tagName||"IMG"==R.tagName){var d=document.createElement("canvas");d.width=R.width,d.height=R.height;var m=d.getContext("2d");m.drawImage(R,0,0,R.width,R.height)}else if("CANVAS"==R.tagName)var m=R.getContext("2d");for(var b=m.getImageData(o,n,u,h),F=[],E=0;E<g.length;E++)F[E]=[],F[E][0]=g[E][0]-o,F[E][1]=g[E][1]-n;for(var x=[],E=0;E<r.length;E++)x.push(F[r[E][0]][0]/u),x.push(F[r[E][0]][1]/h),x.push(F[r[E][1]][0]/u),x.push(F[r[E][1]][1]/h),x.push(F[r[E][2]][0]/u),x.push(F[r[E][2]][1]/h);if(l){var D=["attribute vec2 a_position;","","uniform vec2 u_resolution;","","void main() {","  vec2 zeroToOne = a_position / u_resolution;","  vec2 zeroToTwo = zeroToOne * 2.0;","  vec2 clipSpace = zeroToTwo - 1.0;","  gl_Position = vec4(clipSpace * vec2(1, -1), 0, 1);","}"].join("\n"),w=["void main() {","  gl_FragColor = vec4(0.2, 0.2, 0.2, 1.0);","}"].join("\n"),B=loadShader(e,D,e.VERTEX_SHADER),P=loadShader(e,w,e.FRAGMENT_SHADER);try{T=createProgram(e,[B,P])}catch(e){alert("There was a problem setting up the webGL programs. Maybe you should try it in another browser. :(")}c=e.createBuffer();var S=["attribute vec2 a_texCoord;","attribute vec2 a_position;","","varying vec2 v_texCoord;","","uniform vec2 u_resolution;","","void main() {","  vec2 zeroToOne = a_position / u_resolution;","  vec2 zeroToTwo = zeroToOne * 2.0;","  vec2 clipSpace = zeroToTwo - 1.0;","  gl_Position = vec4(clipSpace * vec2(1, -1), 0, 1);","  ","  v_texCoord = a_texCoord;","}"].join("\n"),U=["precision mediump float;","","uniform sampler2D u_image;","","varying vec2 v_texCoord;","","void main() {","  gl_FragColor = texture2D(u_image, v_texCoord);","}"].join("\n"),L=loadShader(e,S,e.VERTEX_SHADER),C=loadShader(e,U,e.FRAGMENT_SHADER);f=createProgram(e,[L,C]),s=e.createBuffer(),l=!1}e.useProgram(T);var I=e.getUniformLocation(T,"u_resolution");e.uniform2f(I,e.drawingBufferWidth,e.drawingBufferHeight),e.useProgram(f),A=e.getAttribLocation(f,"a_texCoord"),e.enableVertexAttribArray(A),e.bindBuffer(e.ARRAY_BUFFER,s),e.bufferData(e.ARRAY_BUFFER,new Float32Array(x),e.STATIC_DRAW),e.vertexAttribPointer(A,2,e.FLOAT,!1,0,0);var M=e.createTexture();e.bindTexture(e.TEXTURE_2D,M),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.LINEAR),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.LINEAR),e.texImage2D(e.TEXTURE_2D,0,e.RGBA,e.RGBA,e.UNSIGNED_BYTE,b),I=e.getUniformLocation(f,"u_resolution"),e.uniform2f(I,e.drawingBufferWidth,e.drawingBufferHeight)},this.draw=function(a){R&&(e.useProgram(f),e.enableVertexAttribArray(A),e.bindBuffer(e.ARRAY_BUFFER,s),e.vertexAttribPointer(A,2,e.FLOAT,!1,0,0),R=!1);for(var o=[],i=0;i<r.length;i++)o.push(a[r[i][0]][0]),o.push(a[r[i][0]][1]),o.push(a[r[i][1]][0]),o.push(a[r[i][1]][1]),o.push(a[r[i][2]][0]),o.push(a[r[i][2]][1]);var n=e.getAttribLocation(f,"a_position"),u=e.createBuffer();e.bindBuffer(e.ARRAY_BUFFER,u),e.enableVertexAttribArray(n),e.vertexAttribPointer(n,2,e.FLOAT,!1,0,0),e.bufferData(e.ARRAY_BUFFER,new Float32Array(o),e.STATIC_DRAW),e.drawArrays(e.TRIANGLES,0,3*t)},this.drawGrid=function(a){R||(e.useProgram(T),R=!0);for(var o=[],i=0;i<r.length;i++)o.push(a[r[i][0]][0]),o.push(a[r[i][0]][1]),o.push(a[r[i][1]][0]),o.push(a[r[i][1]][1]),o.push(a[r[i][1]][0]),o.push(a[r[i][1]][1]),o.push(a[r[i][2]][0]),o.push(a[r[i][2]][1]),o.push(a[r[i][2]][0]),o.push(a[r[i][2]][1]),o.push(a[r[i][0]][0]),o.push(a[r[i][0]][1]);var n=e.getAttribLocation(T,"a_position");e.bindBuffer(e.ARRAY_BUFFER,c),e.enableVertexAttribArray(n),e.vertexAttribPointer(n,2,e.FLOAT,!1,0,0),e.bufferData(e.ARRAY_BUFFER,new Float32Array(o),e.STATIC_DRAW),e.drawArrays(e.LINES,0,6*t)},this.clear=function(){e.clear(e.COLOR_BUFFER_BIT)},this.calculatePositions=function(e,r){for(var t,a,o,i,n=e.length,u=[],h=0;h<_.patchModel.numPatches;h++){t=_.shapeModel.meanShape[h][0],a=_.shapeModel.meanShape[h][1];for(var s=0;s<n-4;s++)t+=_.shapeModel.eigenVectors[2*h][s]*e[s+4],a+=_.shapeModel.eigenVectors[2*h+1][s]*e[s+4];r&&(o=e[0]*t-e[1]*a+e[2],i=e[0]*a+e[1]*t+e[3],t+=o,a+=i),u[h]=[t,a]}return u}};