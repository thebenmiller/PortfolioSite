"use strict";var webglFilter=function(){var e,r,t,o,i,a,n,l,u,c,f,s,_,d,m,v,h,E,T,A,R,g,w,x,F,p,b,U,C,P,S=!0;this.init=function(v,h,E,T,S,L,B){if(S!=L)return void alert("filter width and height must be same size!");if(S%2==0||L%2==0){t=S+1,o=L+1;for(var y=0;y<h;y++){for(var X=0;X<S;X++)v[y].splice(S*L+X,0,0);for(var X=L+1;X>0;X--)v[y].splice(X*S,0,0)}c=t-1,f=o-1}else t=S,o=L,c=t,f=o;if(i=E,a=T,n=h,D=["precision mediump float;","","uniform vec2 u_onePixelFilters;","uniform vec2 u_onePixelPatches;","const float u_filterwidth = "+c.toFixed(1)+";","const float u_filterheight = "+f.toFixed(1)+";","const float u_halffilterwidth = "+(c/2).toFixed(1)+";","const float u_halffilterheight = "+(f/2).toFixed(1)+";","const float u_filtersize = "+c*f+".0;","const float u_divfiltersize = "+(1/(c*f)).toFixed(10)+";","","// our patches","uniform sampler2D u_patches;","// our filters","uniform sampler2D u_filters;","","// the texCoords passed in from the vertex shader.","varying vec2 v_texCoord;","varying vec2 v_texCoordFilters; // this should give us correct filter","","void main() {","  vec4 colorSum = vec4(0.0, 0.0, 0.0, 0.0);","  // normalize the selection we take first","  vec4 msum = vec4(0.0, 0.0, 0.0, 0.0);","  vec4 msumsq = vec4(0.0, 0.0, 0.0, 0.0);","  vec4 mean = vec4(0.0, 0.0, 0.0, 0.0);","  for (float w = 0.0;w < u_filterwidth;w++) {","    for (float h = 0.0;h < u_filterheight;h++) {","      mean = texture2D(u_patches, v_texCoord + u_onePixelPatches * vec2(w-u_halffilterwidth, h-u_halffilterheight));","      msum += mean;","      msumsq += (mean * mean);","    } ","  }","  mean = msum * u_divfiltersize;","  vec4 sd = sqrt((msumsq * u_divfiltersize) - (mean * mean));","  ","  for (float w = 0.0;w < u_filterwidth;w++) {","    for (float h = 0.0;h < u_filterheight;h++) {","      colorSum += ","        ((texture2D(u_patches, v_texCoord + u_onePixelPatches * vec2(w-u_halffilterwidth, h-u_halffilterheight))-mean)/(sd)) * ","        texture2D(u_filters, v_texCoordFilters + u_onePixelFilters * vec2(w-u_halffilterwidth, h-u_halffilterheight)); ","    } ","  }","  // logit","  colorSum = 1.0-(1.0/(1.0 + exp(colorSum)));","  gl_FragColor = colorSum;","}"].join("\n"),m=Math.floor(n/4)+Math.ceil(n%4),l=i,u=a*m,r=document.createElement("canvas"),r.setAttribute("width",i-c+"px"),r.setAttribute("height",(a-f)*n+"px"),r.setAttribute("id","renderCanvas"),r.setAttribute("style","display:none;"),document.body.appendChild(r),e=setupWebGL(r,{premultipliedAlpha:!1,preserveDrawingBuffer:!0}),!e.getExtension("OES_texture_float"))return void alert("Your graphics card does not support floating point textures! :(");for(var O,N=[],H=c/2,y=0;y<m;y++)O=y*a,N=N.concat([H,O+H,i-H,O+H,H,O+a-H]),N=N.concat([H,O+a-H,i-H,O+H,i-H,O+a-H]);N=new Float32Array(N);for(var q=[],y=0;y<N.length;y++)y%2==0?q[y]=N[y]/l:q[y]=N[y]/u;q=new Float32Array(q);var z=loadShader(e,I,e.VERTEX_SHADER),W=loadShader(e,D,e.FRAGMENT_SHADER);s=createProgram(e,[z,W]),e.useProgram(s);var k=loadShader(e,M,e.VERTEX_SHADER),Y=loadShader(e,G,e.FRAGMENT_SHADER);_=createProgram(e,[k,Y]);var V=e.getUniformLocation(s,"u_resolution");e.uniform2f(V,l,u);var j=e.getUniformLocation(s,"u_patchHeight");e.uniform1f(j,1/m);var K=e.getUniformLocation(s,"u_filterHeight");e.uniform1f(K,1/m);var J=e.getUniformLocation(s,"u_midpoint");e.uniform2f(J,.5,1/(2*m));var Q=e.getUniformLocation(s,"u_onePixelPatches");e.uniform2f(Q,1/i,1/(a*m));var Z=e.getUniformLocation(s,"u_onePixelFilters");e.uniform2f(Z,1/t,1/(o*m));var $=e.getAttribLocation(s,"a_position");x=e.createBuffer(),e.bindBuffer(e.ARRAY_BUFFER,x),e.bufferData(e.ARRAY_BUFFER,N,e.STATIC_DRAW),e.enableVertexAttribArray($),e.vertexAttribPointer($,2,e.FLOAT,!1,0,0),w=e.getAttribLocation(s,"a_texCoord"),g=e.createBuffer(),e.bindBuffer(e.ARRAY_BUFFER,g),e.bufferData(e.ARRAY_BUFFER,q,e.STATIC_DRAW),e.enableVertexAttribArray(w),e.vertexAttribPointer(w,2,e.FLOAT,!1,0,0);for(var ee=t*o,re=new Float32Array(ee*(m+1)*4),y=0;y<m;y++)for(var X=0;X<o;X++)for(var te=0;te<t;te++)4*y<v.length?re[4*(ee*y+X*t+te)]=v[4*y][te*t+X]:re[4*(ee*y+X*t+te)]=0,4*y+1<v.length?re[4*(ee*y+X*t+te)+1]=v[4*y+1][te*t+X]:re[4*(ee*y+X*t+te)+1]=0,4*y+2<v.length?re[4*(ee*y+X*t+te)+2]=v[4*y+2][te*t+X]:re[4*(ee*y+X*t+te)+2]=0,4*y+3<v.length?re[4*(ee*y+X*t+te)+3]=v[4*y+3][te*t+X]:re[4*(ee*y+X*t+te)+3]=0;e.activeTexture(e.TEXTURE0),R=e.createTexture(),e.bindTexture(e.TEXTURE_2D,R),e.texImage2D(e.TEXTURE_2D,0,e.RGBA,t,o*m,0,e.RGBA,e.FLOAT,re),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.NEAREST),e.uniform1i(e.getUniformLocation(s,"u_filters"),0),e.activeTexture(e.TEXTURE2),A=e.createTexture(),e.bindTexture(e.TEXTURE_2D,A),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.NEAREST),e.texImage2D(e.TEXTURE_2D,0,e.RGBA,i,a*m,0,e.RGBA,e.FLOAT,null),d=e.createFramebuffer(),e.bindFramebuffer(e.FRAMEBUFFER,d),e.framebufferTexture2D(e.FRAMEBUFFER,e.COLOR_ATTACHMENT0,e.TEXTURE_2D,A,0),e.viewport(0,0,i,a*m),F=i-c,p=a-c,b=p*n,U=new Float32Array(12*n);for(var O,oe,y=0;y<n;y++)O=y*p,oe=12*y,U[oe]=0,U[oe+1]=O,U[oe+2]=F,U[oe+3]=O,U[oe+4]=0,U[oe+5]=O+p,U[oe+6]=0,U[oe+7]=O+p,U[oe+8]=F,U[oe+9]=O,U[oe+10]=F,U[oe+11]=O+p;C=new Float32Array(12*n);for(var ie=Math.floor(n/4)+Math.ceil(n%4),ae=c/2/i,ne=c/2/(a*ie),le=a/(a*ie),y=0;y<n;y++)O=Math.floor(y/4)*le,oe=12*y,C[oe]=ae,C[oe+1]=O+ne,C[oe+2]=1-ae,C[oe+3]=O+ne,C[oe+4]=ae,C[oe+5]=O+le-ne,C[oe+6]=ae,C[oe+7]=O+le-ne,C[oe+8]=1-ae,C[oe+9]=O+ne,C[oe+10]=1-ae,C[oe+11]=O+le-ne;P=new Float32Array(6*n);for(var ue,y=0;y<n;y++)ue=y%4,oe=6*y,P[oe]=ue,P[oe+1]=ue,P[oe+2]=ue,P[oe+3]=ue,P[oe+4]=ue,P[oe+5]=ue},this.getResponses=function(r,t){if(!S){e.useProgram(s);var o=e.getAttribLocation(s,"a_position");e.bindBuffer(e.ARRAY_BUFFER,x),e.enableVertexAttribArray(o),e.vertexAttribPointer(o,2,e.FLOAT,!1,0,0);var n=e.getAttribLocation(s,"a_texCoord");e.bindBuffer(e.ARRAY_BUFFER,g),e.enableVertexAttribArray(n),e.vertexAttribPointer(n,2,e.FLOAT,!1,0,0),e.bindFramebuffer(e.FRAMEBUFFER,d),e.viewport(0,0,i,a*m)}for(var l=r.length,u=Math.floor(l/4)+Math.ceil(l%4),c=i,f=a*u,A=i*a,R=new Float32Array(A*(u+1)*4),w=0,p=0,D=0,I=0;I<u;I++)for(var M=0;M<a;M++)for(var G=0;G<i;G++)p=4*I,D=M*i+G,w=4*(A*I+D),p<l?R[w]=r[p][D]:R[w]=0,p+1<l?R[w+1]=r[p+1][D]:R[w+1]=0,p+2<l?R[w+2]=r[p+2][D]:R[w+2]=0,p+3<l?R[w+3]=r[p+3][D]:R[w+3]=0;if(e.activeTexture(e.TEXTURE1),S&&(v=e.createTexture()),e.bindTexture(e.TEXTURE_2D,v),e.texImage2D(e.TEXTURE_2D,0,e.RGBA,c,f,0,e.RGBA,e.FLOAT,R),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.NEAREST),e.uniform1i(e.getUniformLocation(s,"u_patches"),1),e.clearColor(0,0,0,1),e.clear(e.COLOR_BUFFER_BIT|e.DEPTH_BUFFER),e.drawArrays(e.TRIANGLES,0,6*u),e.finish(),t){e.useProgram(_),e.bindFramebuffer(e.FRAMEBUFFER,null),e.viewport(0,0,F,b),e.clearColor(0,0,0,1),e.clear(e.COLOR_BUFFER_BIT|e.DEPTH_BUFFER);var O=e.getUniformLocation(_,"u_resolutiondraw");e.uniform2f(O,F,b);var N=e.getUniformLocation(_,"u_responses");e.uniform1i(N,2),S&&(h=e.createBuffer()),e.bindBuffer(e.ARRAY_BUFFER,h),e.bufferData(e.ARRAY_BUFFER,U,e.STATIC_DRAW);var o=e.getAttribLocation(_,"a_position_draw");e.enableVertexAttribArray(o),e.vertexAttribPointer(o,2,e.FLOAT,!1,0,0),S&&(T=e.createBuffer()),e.bindBuffer(e.ARRAY_BUFFER,T),e.bufferData(e.ARRAY_BUFFER,C,e.STATIC_DRAW);var H=e.getAttribLocation(_,"a_texCoord_draw");e.enableVertexAttribArray(H),e.vertexAttribPointer(H,2,e.FLOAT,!1,0,0),S&&(E=e.createBuffer()),e.bindBuffer(e.ARRAY_BUFFER,E),e.bufferData(e.ARRAY_BUFFER,P,e.STATIC_DRAW);var q=e.getAttribLocation(_,"a_patchChoice_draw");e.enableVertexAttribArray(q),e.vertexAttribPointer(q,1,e.FLOAT,!1,0,0),e.drawArrays(e.TRIANGLES,0,6*l)}var z=B();z=y(z),z=L(z,l);for(var W=z.length,I=0;I<W;I++)z[I]=X(z[I]);return S=!1,z};var D,L=function(e,r){for(var t=[],o=e.length,i=o/r,a=[],n=0;n<o;n++)n%i==0&&(0!=n&&t.push(a),a=[]),a.push(e[n]);return t.push(a),t},B=function(){var t=new Uint8Array(4*r.width*r.height);(new Date).getTime(),e.readPixels(0,0,r.width,r.height,e.RGBA,e.UNSIGNED_BYTE,t);return t},y=function(e){for(var r=[],t=e.length,o=0;o<t;o+=4)r[o/4>>0]=e[o]/4294967296+e[o+1]/16777216+e[o+2]/65536+e[o+3]/256;return r},X=function(e){for(var r=e.length,t=0,o=1,i=0;i<r;i++)t=e[i]>t?e[i]:t,o=e[i]<o?e[i]:o;var a=t-o;if(0==a)console.log("a patchresponse was monotone, causing normalization to fail. Leaving it unchanged."),e=e.map(function(){return 1});else for(var i=0;i<r;i++)e[i]=(e[i]-o)/a;return e},I=["attribute vec2 a_texCoord;","attribute vec2 a_position;","","uniform vec2 u_resolution;","uniform float u_patchHeight;","uniform float u_filterHeight;","uniform vec2 u_midpoint;","","varying vec2 v_texCoord;","varying vec2 v_texCoordFilters;","","void main() {","   // convert the rectangle from pixels to 0.0 to 1.0","   vec2 zeroToOne = a_position / u_resolution;","","   // convert from 0->1 to 0->2","   vec2 zeroToTwo = zeroToOne * 2.0;","","   // convert from 0->2 to -1->+1 (clipspace)","   vec2 clipSpace = zeroToTwo - 1.0;","   ","   // transform coordinates to regular coordinates","   gl_Position = vec4(clipSpace * vec2(1.0, 1.0), 0, 1);"," ","   // pass the texCoord to the fragment shader","   v_texCoord = a_texCoord;","   ","   // set the filtertexture coordinate based on number filter to use","   v_texCoordFilters = u_midpoint + vec2(0.0, u_filterHeight * floor(a_texCoord[1]/u_patchHeight));","}"].join("\n"),M=["attribute vec2 a_texCoord_draw;","attribute vec2 a_position_draw;","attribute float a_patchChoice_draw;","","uniform vec2 u_resolutiondraw;","","varying vec2 v_texCoord;","varying float v_select;","","void main() {","   // convert the rectangle from pixels to 0.0 to 1.0","   vec2 zeroToOne = a_position_draw / u_resolutiondraw;","","   // convert from 0->1 to 0->2","   vec2 zeroToTwo = zeroToOne * 2.0;","","   // convert from 0->2 to -1->+1 (clipspace)","   vec2 clipSpace = zeroToTwo - 1.0;","   ","   // transform coordinates to regular coordinates","   gl_Position = vec4(clipSpace * vec2(1.0, 1.0), 0, 1);","","   // pass the texCoord to the fragment shader","   v_texCoord = a_texCoord_draw;","   ","   v_select = a_patchChoice_draw;","}"].join("\n"),G=["precision mediump float;","","// our responses","uniform sampler2D u_responses;","","// the texCoords passed in from the vertex shader.","varying vec2 v_texCoord;","varying float v_select;","","const vec4 bit_shift = vec4(256.0*256.0*256.0, 256.0*256.0, 256.0, 1.0);","const vec4 bit_mask  = vec4(0.0, 1.0/256.0, 1.0/256.0, 1.0/256.0);","","// packing code from here http://stackoverflow.com/questions/9882716/packing-float-into-vec4-how-does-this-code-work","void main() {","  vec4 colorSum = texture2D(u_responses, v_texCoord);","  float value = 0.0;","  if (v_select == 0.0) {","    value = colorSum[0];","  } else if (v_select == 1.0) {","    value = colorSum[1];","  } else if (v_select == 2.0) {","    value = colorSum[2];","  } else if (v_select == 3.0) {","    value = colorSum[3];","  } else {","    value = 1.0;","  }","  ","  vec4 res = fract(value * bit_shift);","  res -= res.xxyz * bit_mask;","  ","  //gl_FragColor = vec4(value, value, value, value);","  //gl_FragColor = vec4(1.0, value, 1.0, 1.0);","  gl_FragColor = res;","}"].join("\n")};!function(){var e=function(e){window.console&&(window.console.error?window.console.error(e):window.console.log&&window.console.log(e))},r=function(){return window!=window.top},t=function(e){return'<table style="background-color: #8CE; width: 100%; height: 100%;"><tr><td align="center"><div style="display: table-cell; vertical-align: middle;"><div style="">'+e+"</div></div></td></tr></table>"},o='This page requires a browser that supports WebGL.<br/><a href="http://get.webgl.org">Click here to upgrade your browser.</a>',i='It doesn\'t appear your computer can support WebGL.<br/><a href="http://get.webgl.org/troubleshooting/">Click here for more information.</a>',a=function(e,r){function a(r){var o=e.parentNode;o&&(o.innerHTML=t(r))}if(!window.WebGLRenderingContext)return a(o),null;var l=n(e,r);return l||a(i),l},n=function(e,r){for(var t=["webgl","experimental-webgl"],o=null,i=0;i<t.length;++i){try{o=e.getContext(t[i],r)}catch(e){}if(o)break}return o},l=function(){r()&&(document.body.className="iframe")},u=function(e){if(r())l(),e.width=e.clientWidth,e.height=e.clientHeight;else{var t=document.getElementsByTagName("title")[0].innerText,o=document.createElement("h1");o.innerText=t,document.body.insertBefore(o,document.body.children[0])}var i=a(e);return i},c=function(r,t,o,i){var a=i||e,n=r.createShader(o);r.shaderSource(n,t),r.compileShader(n);var l=r.getShaderParameter(n,r.COMPILE_STATUS);return l?n:(lastError=r.getShaderInfoLog(n),a("*** Error compiling shader '"+n+"':"+lastError),r.deleteShader(n),null)},f=function(r,t,o,i){for(var a=r.createProgram(),n=0;n<t.length;++n)r.attachShader(a,t[n]);if(o)for(var n=0;n<o.length;++n)r.bindAttribLocation(a,i?i[n]:n,o[n]);r.linkProgram(a);var l=r.getProgramParameter(a,r.LINK_STATUS);return l?a:(lastError=r.getProgramInfoLog(a),e("Error in program linking:"+lastError),r.deleteProgram(a),null)},s=function(e,r,t,o){var i,a="",n=document.getElementById(r);if(!n)throw"*** Error: unknown script element"+r;if(a=n.text,!t)if("x-shader/x-vertex"==n.type)i=e.VERTEX_SHADER;else if("x-shader/x-fragment"==n.type)i=e.FRAGMENT_SHADER;else if(i!=e.VERTEX_SHADER&&i!=e.FRAGMENT_SHADER)throw"*** Error: unknown shader type";return c(e,a,t?t:i,o)};window.setupWebGL=a,window.createProgram=f,window.createShaderFromScriptElement=s,window.getWebGLContext=u,window.updateCSSIfInIFrame=l,window.loadShader=c,window.requestAnimFrame=function(){return window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(e,r){return window.setTimeout(e,1e3/60)}}(),window.cancelRequestAnimFrame=function(){return window.cancelCancelRequestAnimationFrame||window.webkitCancelRequestAnimationFrame||window.mozCancelRequestAnimationFrame||window.oCancelRequestAnimationFrame||window.msCancelRequestAnimationFrame||window.clearTimeout}()}();