function enablestart(){var e=document.getElementById("startbutton");e.innerText="Start!",e.classList="button",e.addEventListener("click",startVideo)}function startVideo(){document.getElementById("info").remove(),vid.play(),ctrack.start(vid),drawLoop()}function fail(e){var t,a=document.getElementById("info"),r=a.getElementsByTagName("h2")[0],n=a.getElementsByTagName("p")[0],o=document.getElementById("startbutton");"error"==e?t="Something went wrong getting video, try again or with a different browser.":"no video"==e&&(t="Something went wrong getting video, try again or with a different browser."),r.innerText="Oh No!",n.innerText=t,o.remove()}function drawLoop(){stop||requestAnimFrame(drawLoop),ctrack.getCurrentPosition()&&drawShapes(ctrack.getCurrentPosition())}function drawShapes(e){var t=[e[23],e[19],e[22],e[25],e[26],e[23]],a=[e[26],e[24]],r=[e[30],e[18],e[15],e[28],e[31],e[30]],n=[e[31],e[29]],o=[e[44],e[45],e[46],e[48],e[49],e[50],e[51],e[52],e[53],e[54],e[55],e[44]],i=[e[47],e[53]],d=getEyeParameters(t,a),c=getEyeParameters(r,n);videoCtx.drawImage(vid,0,0,400,300);var s=videoCtx.getImageData(0,0,400,300);s.data;rctx.clearRect(0,0,rcanvas.width,rcanvas.height),lctx.clearRect(0,0,lcanvas.width,lcanvas.height);var v=getMouthParameters(o,i),l=(v.x-v.rX,v.y-v.rY,v.rX),g=(c.rX+l)/2,m=(d.rX+l)/2,w=v.rY;lctx.save(),drawScaledGradient(lcanvas,lctx,e[27][0],e[27][1],g,w),lctx.restore(),lctx.save(),lctx.globalCompositeOperation="source-atop",lctx.translate(e[27][0]-v.x,e[27][1]-v.y),lctx.drawImage(vid,0,0,lcanvas.width,lcanvas.height),lctx.restore(),rctx.save(),drawScaledGradient(rcanvas,rctx,e[32][0],e[32][1],m,w),rctx.restore(),rctx.save(),rctx.globalCompositeOperation="source-atop",rctx.translate(e[32][0]-v.x,e[32][1]-v.y),rctx.drawImage(vid,0,0,rcanvas.width,rcanvas.height),rctx.restore()}function drawScaledGradient(e,t,a,r,n,o){var i,d,c,s,v,l=e.width,g=e.height;n>=o?(i=1,c=1,d=o/n,s=n/o,v=t.createRadialGradient(a,r*s,0,a,r*s,n)):(d=1,s=1,i=n/o,c=o/n,v=t.createRadialGradient(a*c,r,0,a*c,r,o)),t.fillStyle=v,v.addColorStop(0,"rgba(255,0,0,1)"),v.addColorStop(.7,"rgba(255,0,0,1)"),v.addColorStop(1,"rgba(255,0,0,0)"),t.setTransform(i,0,0,d,0,0),t.clearRect(0,0,l*(1/i),g*(1/d)),t.rect(0,0,l*(1/i),g*(1/d)),t.fill()}function getMin(e,t){for(var a=999999,r=0;r<e.length;r++)a=Math.min(e[r][t],a);return a}function getMax(e,t){for(var a=-999999,r=0;r<e.length;r++)a=Math.max(e[r][t],a);return a}function getMouthParameters(e,t){var a=getMin(e,0),r=getMax(e,0),n=getMin(e,1),o=getMax(e,1),i=getCenter(e),d=Math.atan2(e[5][1]-e[0][1],e[5][0]-e[0][0]),c=r-a,s=o-n;return{x:i[0],y:i[1],rX:c/1.8,rY:s/1.5,rot:d}}function getEyeParameters(e,t){var a=getCenter(e),r=Math.atan2(e[3][1]-e[0][1],e[3][0]-e[0][0]),n=Math.sqrt(Math.pow(e[2][1]-e[1][1],2)+Math.pow(e[2][0]-e[1][0],2))/2,o=Math.sqrt(Math.pow(t[0][1]-t[1][1],2)+Math.pow(t[0][0]-t[1][0],2));return{x:a[0],y:a[1],rX:n,rY:o,rot:r}}var vid=document.getElementById("videoel"),lcanvas=document.getElementById("l_eye"),lctx=lcanvas.getContext("2d"),rcanvas=document.getElementById("r_eye"),rctx=rcanvas.getContext("2d"),renderCanvas=document.createElement("canvas");renderCanvas.width=400,renderCanvas.height=300;var renderCtx=renderCanvas.getContext("2d"),videoCanvas=document.getElementById("vidcanvas"),videoCtx=videoCanvas.getContext("2d"),ctrack=new clm.tracker({useWebGL:!0});if(ctrack.init(pModel),stats=new Stats,stats.domElement.style.position="absolute",stats.domElement.style.top="0px",document.getElementById("project-container").appendChild(stats.domElement),navigator.getUserMedia=navigator.getUserMedia||navigator.webkitGetUserMedia||navigator.mozGetUserMedia||navigator.msGetUserMedia,window.URL=window.URL||window.webkitURL||window.msURL||window.mozURL,navigator.getUserMedia){var videoSelector={video:!0};if(window.navigator.appVersion.match(/Chrome\/(.*?) /)){var chromeVersion=parseInt(window.navigator.appVersion.match(/Chrome\/(\d+)\./)[1],10);chromeVersion<20&&(videoSelector="video")}navigator.getUserMedia(videoSelector,function(e){vid.mozCaptureStream?vid.mozSrcObject=e:vid.src=window.URL&&window.URL.createObjectURL(e)||e,vid.play()},function(){fail("error")})}else fail("no video");vid.addEventListener("canplay",enablestart,!1);var stop=!1,getCenter=function(e){var t,a,r,n,o,i,d,c,s;for(d=c=s=0,t=0,r=e.length,a=r-1;t<r;a=t++)n=e[t],o=e[a],i=n[1]*o[0]-o[1]*n[0],c+=(n[0]+o[0])*i,s+=(n[1]+o[1])*i,d+=3*i;return[c/d,s/d]};document.addEventListener("clmtrackrIteration",function(e){stats.update()},!1);