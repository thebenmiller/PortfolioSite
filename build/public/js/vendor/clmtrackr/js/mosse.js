"use strict";function mosseFilter(r){var t,a,e,o,i,n,f,h,s,v;this.psr_prev=void 0,this.peak_prev=void 0;var d=!1;if(r||(r={}),void 0===r.drawResponse)r.drawResponse=!1;else if("CANVAS"!=r.drawResponse.tagName)r.drawResponse=!1;else var u=r.drawResponse.getContext("2d");void 0===r.psrThreshold&&(r.psrThreshold=10),void 0===r.eta&&(r.eta=.1),void 0===r.convertToGrayscale&&(r.convertToGrayscale=!0),this.load=function(r){i=r.width,n=r.height,h=i*n,t=[r.real,r.imag],r.top&&r.bottom&&(d=!0,a=[r.top.real,r.top.imag],e=[r.bottom.real,r.bottom.imag]),o=new FFT,o.init(r.width),"undefined"!=typeof Float64Array?(f=new Float64Array(h),v=new Float64Array(h)):(f=new Array(h),v=new Array(h));var u=document.createElement("canvas");u.setAttribute("width",i),u.setAttribute("height",n),s=u.getContext("2d")},this.init=function(r,v){i=r,n=v,h=i*n,t=[[],[]],a=[[],[]],e=[[],[]];for(var u=0;u<h;u++)t[0][u]=0,t[1][u]=0,a[0][u]=0,a[1][u]=0,e[0][u]=0,e[1][u]=0;d=!0,o=new FFT,o.init(r),f="undefined"!=typeof Float64Array?new Float64Array(h):new Array(h);var l=document.createElement("canvas");l.setAttribute("width",i),l.setAttribute("height",n),s=l.getContext("2d")},this.fft=function(r){for(var t=new Array(h),a=0;a<h;a++)t[a]=0;return o.fft2d(r,t),[r,t]},this.fft_inplace=function(r){for(var t=0;t<h;t++)f[t]=0;return o.fft2d(r,f),[r,f]},this.ifft=function(r,t){return o.ifft2d(r,t),r},this.psr=function(r){for(var t,a=0,e=0,o=[],f=0,h=0;h<i;h++)for(var s=0;s<n;s++)t=r[s*i+h],a+=t,f+=t*t,e<t&&(e=t,o=[h,s]);for(var h=-5;h<6;h++)for(var s=-5;s<6;s++)Math.sqrt(h*h+s*s)<5&&(t=r[(o[1]+s)*i+(o[0]+h)],f-=t*t,a-=t);var v=a/r.length,d=Math.sqrt(f/r.length-v*v),u=(e-v)/d;return u},this.getResponse=function(r){var a=l(r);a=c(a);var e=this.fft_inplace(a);p(e,t);var o=this.ifft(e[0],e[1]);return o},this.track=function(o,f,p,m,M,y,F,I){if(!t)return console.log("Mosse-filter needs to be initialized or trained before starting tracking."),!1;if("VIDEO"==o.tagName||"IMG"==o.tagName){var b=Math.round(f/o.width*o.videoWidth),T=Math.round(p/o.height*o.videoHeight),N=Math.round(m/o.width*o.videoWidth),x=Math.round(M/o.height*o.videoHeight);s.drawImage(o,b,T,N,x,0,0,i,n)}else"CANVAS"==o.tagName&&s.drawImage(o,f,p,m,M,0,0,i,n);var _=s.getImageData(0,0,i,n),C=_.data;if(r.convertToGrayscale)for(var R=0;R<h;R++)v[R]=.3*C[4*R],v[R]+=.59*C[4*R+1],v[R]+=.11*C[4*R+2];else for(var R=0;R<h;R++)v[R]=C[4*R];var q=l(v);q=c(q);var D=this.fft_inplace(q),E=g(D,t),G=this.ifft(E[0],E[1]),V=0,k=0,H=[];if(F)for(var W,P,S,U=128,O=0;O<i;O++)for(var z=0;z<n;z++)P=O-i/2,S=z-n/2,W=Math.exp(-.5*(P*P+S*S)/U),G[z*i+O]*W>V&&(V=G[z*i+O]*W,H=[O,z]),G[z*i+O]<k&&(k=G[z*i+O]);else for(var O=0;O<i;O++)for(var z=0;z<n;z++)G[z*i+O]>V&&(V=G[z*i+O],H=[O,z]),G[z*i+O]<k&&(k=G[z*i+O]);if(this.peak_prev=V,r.drawResponse){var j=V-k,B=document.createElement("canvas");B.setAttribute("width",32),B.setAttribute("height",32);for(var J=B.getContext("2d"),K=J.createImageData(32,32),L=K.data,Q=0;Q<1024;Q++){var X=G[Q];X=Math.round((X+Math.abs(k))*(255/j)),L[4*Q]=X,L[4*Q+1]=X,L[4*Q+2]=X,L[4*Q+3]=255}J.putImageData(K,0,0),u.drawImage(B,f,p,m,m)}if(I&&(this.psr_prev=this.psr(G)),y)if(d){if(I)var Y=this.psr_prev;else var Y=this.psr(G);if(Y>r.psrThreshold){for(var Z=[],$=H[0],rr=H[1],O=0;O<i;O++)for(var z=0;z<n;z++)Z[z*i+O]=Math.exp(-((O-$)*(O-$)+(z-rr)*(z-rr))/4);Z=this.fft(Z);for(var tr=w(D),ar=g(Z,tr),er=g(D,tr),or=r.eta,R=0;R<h;R++)a[0][R]=or*ar[0][R]+(1-or)*a[0][R],a[1][R]=or*ar[1][R]+(1-or)*a[1][R],e[0][R]=or*er[0][R]+(1-or)*e[0][R],e[1][R]=or*er[1][R]+(1-or)*e[1][R];t=A(a,e)}}else console.log("The loaded filter does not support updating. Ignoring parameter 'updateFilter'.");return H[0]=H[0]*(m/i),H[1]=H[1]*(m/n),!(V<0)&&H},this.train=function(o,f,u,p,m){if(!d)return console.log("The loaded filter does not support updating. Unable to do training."),!1;if("VIDEO"==o.tagName||"IMG"==o.tagName){var M=Math.round(f/o.width*o.videoWidth),y=Math.round(u/o.height*o.videoHeight),F=Math.round(p/o.width*o.videoWidth),I=Math.round(m/o.height*o.videoHeight);s.drawImage(o,M,y,F,I,0,0,i,n)}else"CANVAS"==o.tagName&&s.drawImage(o,f,u,p,m,0,0,i,n);for(var b=s.getImageData(0,0,i,n),T=b.data,N=0;N<h;N++)v[N]=.3*T[4*N],v[N]+=.59*T[4*N+1],v[N]+=.11*T[4*N+2];var x=l(v);x=c(x);for(var _=[],C=i/2,R=n/2,q=0;q<i;q++)for(var D=0;D<n;D++)_[D*i+q]=Math.exp(-((q-C)*(q-C)+(D-R)*(D-R))/4);_=this.fft(_);for(var E=this.fft(x),G=w(E),V=g(_,G),k=g(E,G),H=r.eta,N=0;N<h;N++)a[0][N]=H*V[0][N]+(1-H)*a[0][N],a[1][N]=H*V[1][N]+(1-H)*a[1][N],e[0][N]=H*k[0][N]+(1-H)*e[0][N],e[1][N]=H*k[1][N]+(1-H)*e[1][N];return t=A(a,e),!0};var l=function(r){for(var t=0;t<h;t++)r[t]=Math.log(r[t]+1);for(var a=0,t=0;t<h;t++)a+=r[t];a/=h;for(var t=0;t<h;t++)r[t]-=a;for(var e=0,t=0;t<h;t++)e+=r[t]*r[t];e=Math.sqrt(e);for(var t=0;t<h;t++)r[t]/=e;return r},c=function(r){for(var t=0,a=0;a<i;a++)for(var e=0;e<n;e++){var o=Math.sin(Math.PI*a/(i-1)),f=Math.sin(Math.PI*e/(n-1));r[t]=Math.min(o,f)*r[t],t++}return r},g=function(r,t){for(var a=new Array(i),e=new Array(i),o=[a,e],n=0;n<h;n++)o[0][n]=r[0][n]*t[0][n]-r[1][n]*t[1][n],o[1][n]=r[0][n]*t[1][n]+r[1][n]*t[0][n];return o},p=function(r,t){for(var a,e,o=0;o<h;o++)a=r[0][o]*t[0][o]-r[1][o]*t[1][o],e=r[0][o]*t[1][o]+r[1][o]*t[0][o],r[0][o]=a,r[1][o]=e},w=function(r){for(var t=[[],[]],a=0;a<h;a++)t[0][a]=r[0][a],t[1][a]=-r[1][a];return t},A=function(r,t){for(var a=[[],[]],e=0;e<h;e++)a[0][e]=(r[0][e]*t[0][e]+r[1][e]*t[1][e])/(t[0][e]*t[0][e]+t[1][e]*t[1][e]),a[1][e]=(r[1][e]*t[0][e]-r[0][e]*t[1][e])/(t[0][e]*t[0][e]+t[1][e]*t[1][e]);return a}}function FFT(){function r(r,t,a){for(var e,o,i,s,v,d,u,l,c,g=n>>2,p=0;p<n;p++)s=f[p],p<s&&(v=r[p],r[p]=r[s],r[s]=v,v=t[p],t[p]=t[s],t[s]=v);for(var w=1;w<n;w<<=1){o=0,e=n/(w<<1);for(var A=0;A<w;A++){d=h[o+g],u=a*h[o];for(var m=A;m<n;m+=w<<1)i=m+w,l=d*r[i]+u*t[i],c=d*t[i]-u*r[i],r[i]=r[m]-l,r[m]+=l,t[i]=t[m]-c,t[m]+=c;o+=e}}}function t(){f="undefined"!=typeof Uint8Array?new Uint8Array(n):new Array(n),"undefined"!=typeof Float64Array?(h=new Float64Array(1.25*n),o=new Float64Array(n*n),i=new Float64Array(n*n)):(h=new Array(1.25*n),o=new Array(n*n),i=new Array(n*n))}function a(){var r=0,t=0,a=0;for(f[0]=0;++r<n;){for(a=n>>1;a<=t;)t-=a,a>>=1;t+=a,f[r]=t}}function e(){var r=n>>1,t=n>>2,a=n>>3,e=r+t,o=Math.sin(Math.PI/n),i=2*o*o,f=Math.sqrt(i*(2-i)),s=h[t]=1,v=h[0]=0;o=2*i;for(var d=1;d<a;d++)s-=i,i+=o*s,v+=f,f-=o*v,h[d]=v,h[t-d]=s;0!==a&&(h[a]=Math.sqrt(.5));for(var u=0;u<t;u++)h[r-u]=h[u];for(var l=0;l<e;l++)h[l+r]=-h[l]}var o,i,n=0,f=null,h=null;this.init=function(r){if(0===r||0!==(r&r-1))throw new Error("init: radix-2 required");n=r,t(),a(),e()},this.fft1d=function(t,a){r(t,a,1)},this.ifft1d=function(t,a){var e=1/n;r(t,a,-1);for(var o=0;o<n;o++)t[o]*=e,a[o]*=e},this.fft2d=function(r,t){for(var a=0,e=0;e<n;e++){a=e*n;for(var f=0;f<n;f++)o[f]=r[f+a],i[f]=t[f+a];this.fft1d(o,i);for(var h=0;h<n;h++)r[h+a]=o[h],t[h+a]=i[h]}for(var s=0;s<n;s++){for(var v=0;v<n;v++)a=s+v*n,o[v]=r[a],i[v]=t[a];this.fft1d(o,i);for(var d=0;d<n;d++)a=s+d*n,r[a]=o[d],t[a]=i[d]}},this.ifft2d=function(r,t){for(var a=0,e=0;e<n;e++){a=e*n;for(var f=0;f<n;f++)o[f]=r[f+a],i[f]=t[f+a];this.ifft1d(o,i);for(var h=0;h<n;h++)r[h+a]=o[h],t[h+a]=i[h]}for(var s=0;s<n;s++){for(var v=0;v<n;v++)a=s+v*n,o[v]=r[a],i[v]=t[a];this.ifft1d(o,i);for(var d=0;d<n;d++)a=s+d*n,r[a]=o[d],t[a]=i[d]}}}