"use strict";var clm={tracker:function(e){function t(e,t,n){var r,o,a,s,h;r=2*t,o=V[r/2][0],a=V[r/2][1];for(var l=0;l<i;l++)o+=m.shapeModel.eigenVectors[r][l]*n[l+4],a+=m.shapeModel.eigenVectors[r+1][l]*n[l+4];s=n[0]*o-n[1]*a+n[2],h=n[0]*a+n[1]*o+n[3],o+=s,a+=h,e.beginPath(),e.arc(o,a,1,0,2*Math.PI,!0),e.closePath(),e.fill()}function n(e,t){for(var n=[],r=[],o=0;o<e.length;o++)n[o]=[e[o][0],e[o][1]];for(var o=0;o<t.length;o++)r[o]=[t[o][0],t[o][1]];t=r,e=n;for(var i=[0,0],o=0;o<e.length;o++)i[0]+=e[o][0],i[1]+=e[o][1];i[0]/=e.length,i[1]/=e.length;for(var a=[0,0],o=0;o<t.length;o++)a[0]+=t[o][0],a[1]+=t[o][1];a[0]/=t.length,a[1]/=t.length;for(var s=i[0]-a[0],h=i[1]-a[1],o=0;o<t.length;o++)t[o][0]-=a[0],t[o][1]-=a[1];for(var o=0;o<e.length;o++)e[o][0]-=i[0],e[o][1]-=i[1];for(var l=0,o=0;o<t.length;o++)l+=t[o][0]*t[o][0],l+=t[o][1]*t[o][1];l=Math.sqrt(l/t.length);for(var c=0,o=0;o<e.length;o++)c+=e[o][0]*e[o][0],c+=e[o][1]*e[o][1];c=Math.sqrt(c/e.length);for(var d=c/l,o=0;o<t.length;o++)t[o][0]*=d,t[o][1]*=d;for(var f=0,u=0,o=0;o<t.length;o++)f+=t[o][0]*e[o][1]-t[o][1]*e[o][0],u+=t[o][0]*e[o][0]+t[o][1]*e[o][1];var v=Math.atan(f/u);return s+=a[0]-d*Math.cos(-v)*a[0]-d*a[1]*Math.sin(-v),h+=a[1]+d*Math.sin(-v)*a[0]-d*a[1]*Math.cos(-v),[s,h,d,v]}e||(e={}),void 0===e.constantVelocity&&(e.constantVelocity=!0),void 0===e.searchWindow&&(e.searchWindow=11),void 0===e.useWebGL&&(e.useWebGL=!0),void 0===e.scoreThreshold&&(e.scoreThreshold=.5),void 0===e.stopOnConvergence&&(e.stopOnConvergence=!1),void 0===e.weightPoints&&(e.weightPoints=void 0),void 0===e.sharpenResponse&&(e.sharpenResponse=!1);var r,o,i,a,s,h,l,c,d,f,u,v,g,m,w,p,M,y,b,F,E,R=!1,x=!1,A=[],S=[],k=[],C=[],P=[],_=[],V=[],T="single",q=["raw"],z=0,O=[10,5,1],I=.1,L=!0,N=.01,W=[],G=[];if("undefined"!=typeof Float64Array)var j=new Float64Array(2),D=new Float64Array(2);else var j=new Array(2),D=new Array(2);var B,J,U,H,K,Q,X,Y,Z,$,ee,te,ne,re,oe,ie,ae,se,he,le,ce,de=0,fe=document.createElement("canvas"),ue=fe.getContext("2d"),ve=[],ge=0,me=[0,0],we=[0,0],pe=[0,0],Me=Math.PI/2;this.init=function(t){m=t,a=m.patchModel.patchType,r=m.patchModel.numPatches,o=m.patchModel.patchSize[0],p="MOSSE"==a?o:e.searchWindow,i=m.shapeModel.numEvalues,M=m.patchModel.canvasSize[0],y=m.patchModel.canvasSize[1],u=document.createElement("canvas"),c=u.getContext("2d"),d=u.width=M+(p-1)+o-1,f=u.height=y+(p-1)+o-1,m.hints&&mosseFilter&&left_eye_filter&&right_eye_filter&&nose_filter?(oe=new mosseFilter,oe.load(left_eye_filter),ie=new mosseFilter,ie.load(right_eye_filter),ae=new mosseFilter,ae.load(nose_filter)):console.log("MOSSE filters not found, using rough approximation for initialization."),h=numeric.rep([2*r,i],0);for(var n=0;n<2*r;n++)for(var v=0;v<i;v++)h[n][v]=m.shapeModel.eigenVectors[n][v];for(var n=0;n<r;n++)V[n]=[m.shapeModel.meanShape[n][0],m.shapeModel.meanShape[n][1]];Z=$=0,X=Y=1e6;for(var n=0;n<r;n++)V[n][0]<X&&(X=V[n][0]),V[n][1]<Y&&(Y=V[n][1]),V[n][0]>Z&&(Z=V[n][0]),V[n][1]>$&&($=V[n][1]);ee=Z-X,te=$-Y,m.scoring&&(ne=new Float64Array(m.scoring.coef),re=m.scoring.bias,fe.width=m.scoring.size[0],fe.height=m.scoring.size[1]),l=m.shapeModel.eigenValues,g=m.patchModel.weights,w=m.patchModel.bias,s=numeric.rep([i+4,i+4],0);for(var n=0;n<i;n++)m.shapeModel.nonRegularizedVectors.indexOf(n)>=0?s[n+4][n+4]=1e-7:s[n+4][n+4]=1/l[n];for(var n=0;n<i+4;n++)A[n]=0;if("SVM"==a){var S,k=document.createElement("canvas");if(window.WebGLRenderingContext&&(S=k.getContext("webgl")||k.getContext("experimental-webgl"),S&&S.getExtension("OES_texture_float")||(S=null)),S&&e.useWebGL&&"undefined"!=typeof webglFilter){H=new webglFilter;try{H.init(g,w,r,p+o-1,p+o-1,o,o),"lbp"in g&&(x=!0),"sobel"in g&&(R=!0)}catch(e){alert("There was a problem setting up webGL programs, falling back to slightly slower javascript version. :("),H=void 0,K=new svmFilter,K.init(g.raw,w.raw,r,o,p)}}else{if("undefined"==typeof svmFilter)throw"Could not initiate filters, please make sure that svmfilter.js or svmfilter_conv_js.js is loaded.";K=new svmFilter,K.init(g.raw,w.raw,r,o,p)}}else"MOSSE"==a&&(Q=new mosseFilterResponses,Q.init(g,r,o,o));if(B=J="SVM"==a?o+p-1:p,U=B*J,b=(p-1)/2,E=p*p,"undefined"!=typeof Float64Array){F=new Float64Array(E);for(var n=0;n<r;n++)P[n]=new Float64Array(U)}else{F=new Array(E);for(var n=0;n<r;n++)P[n]=new Array(U)}for(var n=0;n<r;n++)W[n]=1,G[n]=0;if(e.weightPoints){ce=[];for(var n=0;n<r;n++)n in e.weightPoints?(ce[2*n]=e.weightPoints[n],ce[2*n+1]=e.weightPoints[n]):(ce[2*n]=1,ce[2*n+1]=1);ce=numeric.diag(ce)}},this.start=function(e,t){return"undefined"==typeof m?(console.log("tracker needs to be initalized before starting to track."),!1):("undefined"==typeof he&&(he=e,le=t),void(se=_e(ye)))},this.stop=function(){Ve(se)},this.track=function(t,n){var o,u,v,g,m,w,M;if(L){var y=Ce(t,n);if(!y){var b=document.createEvent("Event");return b.initEvent("clmtrackrNotFound",!0,!0),document.dispatchEvent(b),!1}o=y[0],g=y[1],u=y[2],v=y[3],L=!1}else{if(de+=1,e.constantVelocity&&k.length>=2)for(var E=0;E<A.length;E++)A[E]=I*k[1][E]+(1-I)*(2*k[1][E]-k[0][E]);g=Me-Math.atan((A[0]+1)/A[1]),g>Me&&(g-=Math.PI),o=A[1]/Math.sin(g),u=A[2],v=A[3]}c.save(),c.clearRect(0,0,d,f),c.scale(1/o,1/o),c.rotate(-g),c.translate(-u,-v),c.drawImage(t,0,0,t.width,t.height),c.restore();var R=Re(A,!1);if(ne&&de%10==0&&!ke()){L=!0,ve=[];for(var E=0;E<A.length;E++)A[E]=0,k=[];var b=document.createEvent("Event");return b.initEvent("clmtrackrLost",!0,!0),document.dispatchEvent(b),!1}for(var x,V,T,E=0;E<r;E++){w=R[E][0]-B/2,M=R[E][1]-J/2,m=c.getImageData(Math.round(w),Math.round(M),B,J),x=m.data,V=P[E];for(var q=0;q<U;q++)T=.3*x[4*q]+.59*x[4*q+1]+.11*x[4*q+2],V[q]=T}if("SVM"==a)if("undefined"!=typeof H)_=Fe(P);else{if("undefined"==typeof K)throw"SVM-filters do not seem to be initiated properly.";_=K.getResponses(P)}else"MOSSE"==a&&(_=Q.getResponses(P));if(e.sharpenResponse)for(var E=0;E<r;E++)for(var q=0;q<_[E].length;q++)_[E][q]=Math.pow(_[E][q],e.sharpenResponse);for(var z,W=S,G=[],E=0;E<O.length;E++){z=Ee(A,h);for(var X,Y,q=0;q<r;q++){X=W[q][0]-(p-1)*o/2,Y=W[q][1]-(p-1)*o/2;var Z=Ae(p,S[q],j,F,_,X,Y,q,O[E],o);Se(p,D,j,F,Z,X,Y,o),G[q]=[D[0]-S[q][0],D[1]-S[q][1]]}for(var $=numeric.rep([2*r,1],0),ee=0;ee<r;ee++)$[2*ee][0]=G[ee][0],$[2*ee+1][0]=G[ee][1];var te=numeric.mul(s,O[E]);if(e.weightPoints)var re=numeric.dot(numeric.transpose(z),numeric.dot(ce,z));else var re=numeric.dot(numeric.transpose(z),z);for(var oe=numeric.rep([i+4,1],0),ie=0;ie<i+4;ie++)oe[ie][0]=A[ie];var ae=numeric.dot(te,oe);if(e.weightPoints)var se=numeric.dot(numeric.transpose(z),numeric.dot(ce,$));else var se=numeric.dot(numeric.transpose(z),$);for(var he=numeric.add(te,re),le=numeric.sub(ae,se),fe=numeric.dot(numeric.inv(he),le),ue=S,ee=0;ee<i+4;ee++)A[ee]-=fe[ee];for(var ge,ee=0;ee<i;ee++)ge=Math.abs(3*Math.sqrt(l[ee])),Math.abs(A[ee+4])>ge&&(A[ee+4]>0?A[ee+4]=ge:A[ee+4]=-ge);S=Re(A,!0);for(var me,we,pe=0,ee=0;ee<S.length;ee++)me=S[ee][0]-ue[ee][0],we=S[ee][1]-ue[ee][1],pe+=me*me+we*we;if(pe<N)break}e.constantVelocity&&(k.push(A.slice()),k.splice(0,3==k.length?1:0)),C.splice(0,10==C.length?1:0),C.push(S.slice(0));var b=document.createEvent("Event");if(b.initEvent("clmtrackrIteration",!0,!0),document.dispatchEvent(b),this.getConvergence()<.5&&ve.length>=5){e.stopOnConvergence&&this.stop();var b=document.createEvent("Event");b.initEvent("clmtrackrConverged",!0,!0),document.dispatchEvent(b)}return S},this.reset=function(){L=!0,ve=[];for(var e=0;e<A.length;e++)A[e]=0,k=[];he=void 0,le=void 0},this.draw=function(e,n,r){var o;o=void 0===n?A.slice(0):n.slice(0);var i=e.getContext("2d");i.fillStyle="rgb(200,200,200)",i.strokeStyle="rgb(130,255,50)";var a;a=void 0===r?m.path.normal:m.path[r];for(var s=0;s<a.length;s++)"number"==typeof a[s]?t(i,a[s],o):Pe(i,a[s],o)},this.getScore=function(){return ge},this.calculatePositions=function(e){return Re(e,!0)},this.getCurrentPosition=function(){return!L&&S},this.getCurrentParameters=function(){return A},this.getConvergence=function(){if(C.length<10)return 999999;for(var e=0,t=0,n=0,o=0,i=0;i<5;i++)for(var a=0;a<r;a++)e+=C[i][a][0],t+=C[i][a][1];e/=5,t/=5;for(var i=5;i<10;i++)for(var a=0;a<r;a++)n+=C[i][a][0],o+=C[i][a][1];n/=5,o/=5;var s=n-e,h=o-t,l=s*s+h*h;return l/=C.length},this.setResponseMode=function(e,t){if("undefined"==typeof m)return void console.log("Clmtrackr has not been initialized with a model yet. No changes made.");if("undefined"==typeof H)return void console.log("Responsemodes are only allowed when using webGL. In pure JS, only 'raw' mode is available.");if(["single","blend","cycle"].indexOf(e)<0)return void console.log("Tried to set an unknown responsemode : '"+e+"'. No changes made.");if(!(t instanceof Array))return void console.log("List in setResponseMode must be an array of strings! No changes made.");for(var n=0;n<t.length;n++)["raw","sobel","lbp"].indexOf(t[n])<0&&console.log("Unknown element in responsemode list : '"+t[n]+"'. No changes made."),"sobel"==t[n]&&0==R&&console.log("The sobel filters have not been initialized! No changes made."),"lbp"==t[n]&&0==x&&console.log("The LBP filters have not been initialized! No changes made.");z=0,T=e,q=t};var ye=function(){se=_e(ye);for(var e=(new Date).getTime();(new Date).getTime()-e<16;){this.track(he,le)}}.bind(this),be=function(e,t){return"lbp"==e?H.getLBPResponses(t):"raw"==e?H.getRawResponses(t):"sobel"==e?H.getSobelResponses(t):void 0},Fe=function(e){if("single"==T)return be(q[0],e);if("cycle"==T){var t=be(q[z],e);return z++,z>=q.length&&(z=0),t}for(var n=[],o=0;o<q.length;o++)n[o]=be(q[o],e);for(var i=[],o=0;o<r;o++){for(var t=Array(p*p),a=0;a<p*p;a++)t[a]=0;for(var s=0;s<q.length;s++)for(var a=0;a<p*p;a++)t[a]+=n[s][o][a]/q.length;i[o]=t}return i},Ee=function(e,t){for(var n,o,a=numeric.rep([2*r,i+4],0),s=0;s<r;s++){n=V[s][0],o=V[s][1];for(var h=0;h<i;h++)n+=e[h+4]*t[2*s][h],o+=e[h+4]*t[2*s+1][h];a[2*s][0]=n,a[2*s+1][0]=o,n=V[s][1],o=V[s][0];for(var h=0;h<i;h++)n+=e[h+4]*t[2*s+1][h],o+=e[h+4]*t[2*s][h];a[2*s][1]=-n,a[2*s+1][1]=o,a[2*s][2]=1,a[2*s+1][2]=0,a[2*s][3]=0,a[2*s+1][3]=1;for(var l=0;l<i;l++)n=e[0]*t[2*s][l]-e[1]*t[2*s+1][l]+t[2*s][l],o=e[0]*t[2*s+1][l]+e[1]*t[2*s][l]+t[2*s+1][l],a[2*s][l+4]=n,a[2*s+1][l+4]=o}return a},Re=function(e,t){for(var n,o,i,a,s=e.length,h=[],l=0;l<r;l++){n=V[l][0],o=V[l][1];for(var c=0;c<s-4;c++)n+=m.shapeModel.eigenVectors[2*l][c]*e[c+4],o+=m.shapeModel.eigenVectors[2*l+1][c]*e[c+4];t&&(i=e[0]*n-e[1]*o+e[2],a=e[0]*o+e[1]*n+e[3],n+=i,o+=a),h[l]=[n,o]}return h},xe=function(e){var t=document.createElement("canvas");t.width=e.width,t.height=e.height;var n=t.getContext("2d");n.drawImage(e,0,0,e.width,e.height);var r=new jsfeat_face(t),o=r.findFace();if(!(o.length>0))return!1;v=o[0];for(var i=1;i<o.length;i++)o[i].confidence>v.confidence&&(v=o[i]);return v},Ae=function(e,t,n,r,o,i,a,s,h,l){for(var c,d,f=0,u=0,v=0;v<e;v++){n[1]=a+v*l;for(var g=0;g<e;g++)n[0]=i+g*l,c=t[0]-n[0],d=t[1]-n[1],r[f]=o[s][f]*Math.exp(-.5*(c*c+d*d)/(h*l)),u+=r[f],f++}return u},Se=function(e,t,n,r,o,i,a,s){var h=0,l=0;t[0]=0,t[1]=0;for(var c=0;c<e;c++){n[1]=a+c*s;for(var d=0;d<e;d++)n[0]=i+d*s,l=r[h]/o,t[0]+=l*n[0],t[1]+=l*n[1],h++}},ke=function(){ue.drawImage(u,Math.round(X+ee/4.5),Math.round(Y-te/12),Math.round(ee-2*ee/4.5),Math.round(te-te/12),0,0,20,22);for(var t=ue.getImageData(0,0,20,22),n=new Array(440),r=t.data,o=0,i=0;i<440;i++)n[i]=.3*r[4*i]+.59*r[4*i+1]+.11*r[4*i+2],n[i]=Math.log(n[i]+1),n[i]>o&&(o=n[i]);if(o>0){for(var a=0,i=0;i<440;i++)a+=n[i];a/=440;for(var s=0,i=0;i<440;i++)s+=(n[i]-a)*(n[i]-a);s/=439,s=Math.sqrt(s);for(var h=0,i=0;i<440;i++)n[i]=(n[i]-a)/s,h+=n[i]*ne[i];if(h+=re,h=1/(1+Math.exp(-h)),ve.splice(0,5==ve.length?1:0),ve.push(h),ve.length>4){ge=0;for(var i=0;i<5;i++)ge+=ve[i];if(ge/=5,ge<e.scoreThreshold)return!1}}return!0},Ce=function(e,t){var r,o,i,a;if(t)v={x:t[0],y:t[1],width:t[2],height:t[3]};else{var s=xe(e);if(!s)return!1}if(m.hints&&mosseFilter&&left_eye_filter&&right_eye_filter&&nose_filter){var h=4.5*v.width/10,l=6*v.width/10,c=ae.track(e,Math.round(v.x+v.width/2-h/2),Math.round(v.y+v.height*(5/8)-h/2),h,h,!1),d=ie.track(e,Math.round(v.x+3*v.width/4-l/2),Math.round(v.y+.4*v.height-l/2),l,l,!1),f=oe.track(e,Math.round(v.x+v.width/4-l/2),Math.round(v.y+.4*v.height-l/2),l,l,!1);me[0]=Math.round(v.x+3*v.width/4-l/2)+d[0],me[1]=Math.round(v.y+.4*v.height-l/2)+d[1],we[0]=Math.round(v.x+v.width/4-l/2)+f[0],we[1]=Math.round(v.y+.4*v.height-l/2)+f[1],pe[0]=Math.round(v.x+v.width/2-h/2)+c[0],pe[1]=Math.round(v.y+v.height*(5/8)-h/2)+c[1];var u=m.hints.leftEye,g=m.hints.rightEye,w=m.hints.nose,p=n([we,me,pe],[u,g,w]);r=p[0],o=p[1],i=p[2],a=p[3],A[0]=i*Math.cos(a)-1,A[1]=i*Math.sin(a),A[2]=r,A[3]=o}else i=v.width/modelheight,r=v.x-xmin*i+.1*v.width,o=v.y-ymin*i+.25*v.height,A[0]=i-1,A[2]=r,A[3]=o;return S=Re(A,!0),[i,a,r,o]},Pe=function(e,t,n){e.beginPath();for(var r,o,a,s,h,l=0;l<t.length;l++){r=2*t[l],o=V[r/2][0],a=V[r/2][1];for(var c=0;c<i;c++)o+=m.shapeModel.eigenVectors[r][c]*n[c+4],a+=m.shapeModel.eigenVectors[r+1][c]*n[c+4];s=n[0]*o-n[1]*a+n[2],h=n[0]*a+n[1]*o+n[3],o+=s,a+=h,0==r?e.moveTo(o,a):e.lineTo(o,a)}e.moveTo(0,0),e.closePath(),e.stroke()},_e=function(){return window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(e,t){return window.setTimeout(e,1e3/60)}}(),Ve=function(){return window.cancelCancelRequestAnimationFrame||window.webkitCancelRequestAnimationFrame||window.mozCancelRequestAnimationFrame||window.oCancelRequestAnimationFrame||window.msCancelRequestAnimationFrame||window.clearTimeout}();return!0}};